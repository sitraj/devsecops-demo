name: IaC Security Scan

on:
    pull_request:
    push:
        branches: ["main"]

permissions:
    security-events: write
    contents: read

jobs:
    tfsec:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Run tfsec
              uses: aquasecurity/tfsec-action@v1.0.3
              with:
                  working_directory: ./infra/terraform
                  additional_args: --minimum-severity CRITICAL --format sarif --out ../../tfsec.sarif

            - name: Upload tfsec report
              if: always()
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: tfsec.sarif

    checkov:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Run Checkov
              uses: bridgecrewio/checkov-action@v12
              with:
                  directory: ./infra/terraform
                  framework: terraform
                  output_format: sarif
                  output_file_path: ../../checkov.sarif
                  soft_fail: true

            - name: Upload Checkov report
              if: always()
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: checkov.sarif

                